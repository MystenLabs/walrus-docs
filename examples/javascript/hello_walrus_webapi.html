<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="color-scheme" content="light dark" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.indigo.min.css" />
    <title>Upload Blobs</title>

    <style>
        article { display: flex; flex-flow: row nowrap; gap: 10px; font-size: smaller; }
        .blob-info { min-width: 0; white-space: nowrap; overflow: hidden; display: flex; flex-flow: column; justify-content: space-between; }
        .blob-info small { font-weight: bold; }
        object { width: 200px; height: 200px; min-width: 200px; object-fit: cover; }
    </style>
</head>

<body>
    <script>
        /**
         * The address of the Walrus daemon running on local host.
         *
         * Change to the address of your own daemon or the publicly available address.
         */
        const ADDRESS = "127.0.0.1:8899";

        /**
         * Handler for submit events from the HTML form.
         *
         * Stores the blob provided in the form, and disable the default HTML form submission.
         */
        function onSubmit(event) {
            // Ensure that the event does not propagate, so that the browser does not
            // perform a POST with the file.
            event.preventDefault();

            // Disable the form while uploading.
            enableForm(false);

            // Store and display the blob, then re-enable the form.
            storeBlob().then((storageInfo) => {
                displayUpload(storageInfo.info, storageInfo.media_type);
                enableForm(true);
            }).catch((error) => {
                console.error(error);
                enableForm(true);
            });

            // Return false to cancel form submission.
            return false;
        }

        /**
         * Stores the file from the HTML form on Walrus.
         */
        function storeBlob() {
            const inputFile = document.getElementById("file-input").files[0];
            const numEpochs = document.getElementById("epochs-input").value;

            // Submit a PUT request with the file's content as the body to the /v1/store endpoint.
            return fetch(`http://${ADDRESS}/v1/store?epochs=${numEpochs}`, {
                method: "PUT",
                body: inputFile,
            }).then((response) => {
                if (response.status === 200) {
                    // Parse successful responses as JSON, and return it along with the
                    // mime type from the the file input element.
                    return response.json().then((info) => {
                        console.log(info);
                        return { info: info, media_type: inputFile.type };
                    });
                } else {
                    throw new Error("Something went wrong when storing the blob!");
                }
            })
        }

        /**
         * Display the result of uploading the file to Walrus.
         */
        function displayUpload(storage_info, media_type) {
            // Extract the displayed fields from either of the two successful responses:
            // - newlyCreated for blobs that have been uploaded for the first time,
            //   or whose duration has been extended.
            // - alreadyCertified for blobs that have already been uploaded and certified.
            if ("alreadyCertified" in storage_info) {
                info = {
                    status: "Already certified",
                    blobId: storage_info.alreadyCertified.blobId,
                    endEpoch: storage_info.alreadyCertified.endEpoch,
                    suiRefType: "Previous Sui Certified Event",
                    suiRef: storage_info.alreadyCertified.event.txDigest,
                };
            } else if ("newlyCreated" in storage_info) {
                info = {
                    status: "Newly created",
                    blobId: storage_info.newlyCreated.blobId,
                    endEpoch: storage_info.newlyCreated.storage.endEpoch,
                    suiRefType: "Associated Sui Object",
                    suiRef: storage_info.newlyCreated.id,
                };
            } else {
                throw Error("Unhandled successful response!");
            }

            // The URL used to download and view the blob.
            const blobUrl = `http://${ADDRESS}/v1/${info.blobId}`;

            const isImage = media_type.startsWith("image");
            // Create the HTML entry in the page for the uploaded blob.
            //
            // For the associated icon, we use the `<object/>` HTML element, as it allows specifying the media type.
            // Walrus by itself returns blobs with 'Content-Type: application/octect-stream' and so it is necessary
            // to specify the content type to the browser in the `object` element.
            document.getElementById("uploaded-blobs").insertAdjacentHTML(
                "afterBegin",
                `<article>
                    <object type="${isImage ? media_type : ''}" data="${isImage ? blobUrl : ''}"></object>
                    <div class="blob-info">
                        <div><small>Status</small><br /> <span>${info.status}</span></div>
                        <div><small>Blob ID</small><br /> <a href="${blobUrl}">${info.blobId}</a></div>
                        <div><small>${info.suiRefType}</small><br /><span>${info.suiRef}</span></div>
                        <div><small>Stored until epoch</small><br /><span>${info.endEpoch}</span></div>
                    </div>
                </article >`);
        }

        /**
         * Helper function to disable the form while uploading.
         */
        function enableForm(isEnabled) {
            if (isEnabled) {
                document.getElementById("upload-form").reset()
                document.querySelector("#upload-form fieldset").removeAttribute("disabled");
            } else {
                document.querySelector("#upload-form fieldset").setAttribute("disabled", "");
            }

            const button = document.getElementById("submit");
            button.setAttribute("aria-busy", isEnabled ? "false" : "true");
            button.innerHTML = isEnabled ? "Upload" : "Uploading ...";
        }
    </script>

    <main class="container">
        <hgroup>
            <h1>Walrus Blob Upload</h1>
            <p>An example uploading and displaying files with Walrus.</p>
        </hgroup>

        <div class="grid">
            <section>
                <hgroup>
                    <h4>Blob Upload</h4>
                    <p>Upload blobs to Walrus, and display them on this page.</p>
                </hgroup>
                <form id="upload-form" onsubmit="return onSubmit(event)">
                    <fieldset>
                        <input id="file-input" type="file" required />
                        <label for="epochs-input"> Number of Walrus epochs for which to store the image.</label>
                        <input id="epochs-input" type="number" value="1" min="1" placeholder="Epochs" required />
                        <button id="submit">Upload</button>
                    </fieldset>
                </form>
            </section>

            <section>
                <h4>Uploaded Blobs</h4>
                <div id="uploaded-blobs">
                    <!-- Container for info about uploaded blobs -->
                </div>
            </section>
        </div>
    </main>
</body>

</html>
